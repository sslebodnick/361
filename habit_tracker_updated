import json
import os
from datetime import date
import time

# ASCII art title
TITLE = '''
=======================
    HABIT TRACKER
=======================
"We are what we repeatedly do. Excellence, then, is not an act,
but a habit." - Aristotle

NOTE: Track your habits in under 2 minutes a day!
'''

DATA_FILE = "habits.json"
COMMANDS = '''
COMMANDS:
Type 'new' to add a new habit to track
Type 'mark' to mark a habit as completed for today
Type 'view' to see all your habits and progress
Type 'edit' to rename an existing habit
Type 'remove' to delete an existing habit
Type 'about' to learn why this program was created
Type 'q' or 'quit' to exit the program
'''

# Map commands to functions (keeps `main()` short so it's under 10 lines)
COMMAND_MAP = {
    'n': 'add_habit', 'new': 'add_habit',
    'm': 'mark_habit', 'mark': 'mark_habit',
    'v': 'view_habits', 'view': 'view_habits',
    'e': 'edit_habit', 'edit': 'edit_habit',
    'r': 'remove_habit', 'remove': 'remove_habit',
    'about': 'about'
}

def clear_screen():
    os.system('cls' if os.name == 'nt' else 'clear')

def load_data():
    if not os.path.exists(DATA_FILE):
        return {}
    with open(DATA_FILE, "r") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f, indent=2)

def print_with_delay(message, delay=0.01):
    for char in message:
        print(char, end='', flush=True)
        time.sleep(delay)
    print()

def pause():
    input("\nPress Enter to continue...")

def list_habits(data):
    print("\nYour habits:")
    for i, h in enumerate(data.keys(), 1):
        print(f"{i}. {h}")

def resolve_choice(data, choice):
    if not choice:
        return None
    if choice.isdigit():
        idx = int(choice) - 1
        return list(data.keys())[idx] if 0 <= idx < len(data) else None
    return choice

def select_habit(prompt):
    data = load_data()
    if not data:
        print_with_delay("\nNo habits available.")
        pause()
        return None, None
    list_habits(data)
    choice = input(prompt)
    name = resolve_choice(data, choice)
    return data, name

def add_habit():
    clear_screen(); print_with_delay("\nADDING NEW HABIT"); print_with_delay("----------------")
    name = input("\nWhat habit would you like to track? (or press Enter to cancel): ")
    if not name:
        print_with_delay("\nCancelled adding new habit.")
        pause(); return
    data = load_data()
    if name in data:
        print_with_delay("\nThis habit is already being tracked!")
    else:
        data[name] = []
        save_data(data); print_with_delay(f"\nGreat! I'll help you track '{name}'.")
    pause()

def mark_habit():
    clear_screen(); print_with_delay("\nMARK HABIT COMPLETE"); print_with_delay("------------------")
    data, name = select_habit("\nWhich habit did you complete? (enter name or number, or press Enter to cancel): ")
    if not name:
        print_with_delay("\nCancelled marking habit.")
        return
    if name not in data:
        print_with_delay("\nHabit not found. Please try again.")
        pause(); return
    today = str(date.today())
    if today in data[name]:
        print_with_delay(f"\nYou've already marked '{name}' as complete today. Great job!")
    else:
        data[name].append(today); save_data(data); print_with_delay(f"\nAwesome! '{name}' marked as completed for today!")
    pause()

def view_habits():
    clear_screen(); data = load_data(); print_with_delay("\nYOUR HABITS & PROGRESS")
    print_with_delay("--------------------")
    if not data:
        print_with_delay("\nNo habits found. Try adding one!")
        pause(); return
    today = str(date.today())
    for habit, dates in data.items():
        status = "✓" if today in dates else "○"
        print(f"\n{status} {habit}"); print(f"   Total completions: {len(dates)}")
        if dates: print(f"   Last completed: {dates[-1]}")
    pause()

def edit_habit():
    clear_screen(); print_with_delay("\nRENAME HABIT"); print_with_delay("-----------")
    data, old = select_habit("\nWhich habit would you like to rename? (enter name or number, or press Enter to cancel): ")
    if not old:
        print_with_delay("\nCancelled renaming."); return
    if old not in data:
        print_with_delay("\nHabit not found. Please try again."); pause(); return
    new = input(f"\nEnter the new name for '{old}' (or press Enter to cancel): ")
    if not new or new == old:
        print_with_delay("\nRename cancelled or unchanged."); pause(); return
    if new in data:
        print_with_delay(f"\nA habit named '{new}' already exists. Choose a different name."); pause(); return
    data[new] = data.pop(old); save_data(data); print_with_delay(f"\nRenamed '{old}' to '{new}'.")
    pause()

def remove_habit():
    clear_screen(); print_with_delay("\nREMOVE HABIT"); print_with_delay("-----------")
    data, name = select_habit("\nWhich habit would you like to remove? (enter name or number, or press Enter to cancel): ")
    if not name:
        print_with_delay("\nCancelled removal."); return
    if name not in data:
        print_with_delay("\nHabit not found. Please try again."); pause(); return
    if input(f"\nAre you sure you want to remove '{name}'? (y/N): ").lower().strip() not in ('y','yes'):
        print_with_delay("\nRemoval cancelled."); pause(); return
    if input("\nThis is permanent. Type DELETE to confirm removal (or press Enter to cancel): ") != 'DELETE':
        print_with_delay("\nRemoval cancelled."); pause(); return
    data.pop(name); save_data(data); print_with_delay(f"\nHabit '{name}' has been removed permanently.")
    pause()

def about():
    clear_screen(); print_with_delay("\nABOUT THIS PROGRAM"); print_with_delay("-------------------")
    print_with_delay("\nI created this program because I wanted to develop new habits and be able to track them easily.")
    print_with_delay("Use this tool to record your daily wins and review progress over time.")
    pause()

def main():
    while True:
        clear_screen(); print(TITLE); print(COMMANDS)
        command = input("\nWhat would you like to do? ").lower().strip()
        if command in ('q','quit','exit'):
            print_with_delay("\nKeep up the good habits! Goodbye!"); break
        mapping = {
            'n': add_habit, 'new': add_habit,
            'm': mark_habit, 'mark': mark_habit,
            'v': view_habits, 'view': view_habits,
            'e': edit_habit, 'edit': edit_habit,
            'r': remove_habit, 'remove': remove_habit,
            'about': about
        }
        fn = mapping.get(command)
        if fn:
            fn(); continue
        print_with_delay("\nI didn't understand that command. Please try again."); time.sleep(1)

if __name__ == "__main__":
    main()
